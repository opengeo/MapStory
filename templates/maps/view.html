{% extends "fullscreen.html" %}
{% load staticfiles %}
{% load i18n %}
{% load mapstory_tags %}

{% block title %}{% trans "Viewer" %}{% endblock %}

{% block head %}
{% include "geonode/ext_header.html" %}
{% include "geonode/app_header.html" %}
{% include "geonode/geo_header.html" %}
<link rel="stylesheet" type="text/css" href="{% static "theme/access-theme-shim.css"%}" />
<link rel="stylesheet" type="text/css" href="{% geonode_static "theme/ux/colorpicker/color-picker.ux.css" %}" />
<style type="text/css">
    #templates { display: none; }
    .gxp-addlayers-sourceselect { display: none; }
</style>



<script src="{% geonode_static "script/PrintPreview.js" %}"></script>
<link rel="stylesheet" type="text/css" href="{% geonode_static "externals/PrintPreview/resources/css/printpreview.css" %}" />
<script src="{{GEOSERVER_BASE_URL}}pdf/info.json?var=printCapabilities" type="text/javascript"></script>
{{ block.super }}



  <script src="{% static "components/jquery/jquery.min.js" %}"></script>
  <script src="{% static "components/underscore/underscore-min.js" %}"></script>
  <script src="{% static "components/backbone/backbone-min.js"%}"></script>
  <script src="{% static "components/bootstrap/js/bootstrap.min.js" %}"></script>
  <script src="{% static "components/bootstrap/js/bootstrap.js" %}"></script>


  <script id="layer-element" type="text/template">

    <div class="ms-layer-title">
      <p>

        <a class="show-meta" href="#"><%= layer.title %></a> by
        <a href="<%= layer.owner_detail %>"><%= layer.owner %></a> on
        <%= layer.last_modified %>
        <a class="ms-add-to-map" href="#">Add to map</a>

      </p>
    </div>

    <div class="ms-layer-info">
      <img src="<%= layer.thumb %>">
      <p class="ms-layer-rating"><%= layer.views %> Views | <%= layer.rating %> Rating</p>
      <p class="ms-layer-abstract"><%= layer.abstract %></p>
    </div>

  </script>

  <script id="add-layer-template" type="text/template">
    <div id="ms-header">
      <form>
        <fieldset>
          <button id="search" type="submit" class="btn">Search</button>
          <input id="query" type="text" class="search-query">
          <select id="sortBy">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="alphaaz">Alphabetical (A-Z)</option>
            <option value="alphaza">Alphabetical (Z-A)</option>
            <option value="popularity">Popularity</option>
            <option value="rel">Relevance</option>
          </select>
        </fieldset>

        <fieldset>

          <label>Limit layers current map area</label>
          <input id="bbox-limit" type="checkbox">

          <label>Show meta info expanded</label>
          <input id="show-meta-info" type="checkbox" checked>

        </fieldset>

      </form>
    </div>

    <div id="ms-search-layers">
      <ul>
      </ul>
    </div>

    <div id="ms-footer">
      <button id="done" class="btn">Done</button>
    </div>

  </script>

  <script src="{% static "script/map-search.js"%}"></script>


<script type="text/javascript">
{% autoescape off %}

var app = new GeoExplorer();

$(function () {

   main({
      geoExplorer: app,
      searchUrl: "{% url new_search_api %}"
   });

});

// template markup specific javascript
(function() {

    var titleTemplate, moreInfoTemplate, permalinkTemplate;
    function permalink(id) {
        return permalinkTemplate.apply({
            protocol: window.location.protocol,
            host: window.location.host,
            id: id
        }) 
    }
    app.on({
        "ready": function() {
            permalinkTemplate = new Ext.Template("{protocol}//{host}/maps/{id}");
            moreInfoTemplate = new Ext.Template(decodeURIComponent(Ext.get("more-info-tpl").dom.innerHTML));
            var mapInfoHtml = app.mapID ? moreInfoTemplate.apply({permalink: permalink(app.mapID)}) : "This map is currently unsaved";
            Ext.DomHelper.overwrite(Ext.get("more-info"), mapInfoHtml)

            titleTemplate = new Ext.Template(Ext.get("title-tpl").dom.innerHTML);
            Ext.DomHelper.overwrite(Ext.get("map-title-header"), titleTemplate.apply({title: app.about.title}));
        },
        "saved": function(id) {
            //reset title header
            Ext.DomHelper.overwrite(Ext.get("map-title-header"), titleTemplate.apply({title: app.about.title}))

            //reset more info link
            Ext.DomHelper.overwrite(Ext.get("more-info"), moreInfoTemplate.apply({permalink: permalink(app.mapID)}))
        },
        scope: {}
    });
    
    var headers = {
        'X-CSRFToken' : Ext.util.Cookies.get('csrftoken')
    };
    Ext.Ajax.defaultHeaders = headers;
    {# MONKEY PATCH #}
    OpenLayers.Request._monkey_issue = OpenLayers.Request.issue;
    OpenLayers.Request.issue = function(config) {
        config.headers = config.headers || {};
        config.headers['X-CSRFToken'] = Ext.util.Cookies.get('csrftoken');
        return this._monkey_issue(config);
    };
})()

// monkey patch the default font property for the FontComboBox
gxp.form.FontComboBox.prototype.defaultFont = 'Arial';
{% endautoescape %}
</script>

{% endblock %}

{% block body %}
<div id="header-wrapper">
  {{ block.super }}
  <div id="topPanel">
    <div id="more-info">&nbsp;</div>
    <span id="map-title-header"></span>
    <a id="add-layers" href="#">Add layers</a>
  </div>
</div>
<div id="templates">
  <div id="more-info-tpl"><a class='link' href='{permalink}'>{% trans "View info" %}</a></div>
  <div id="title-tpl"><a class='maplist' href='{% url maps_search %}'>{% trans "Maps" %}</a> / <strong>{title}</strong></div>
</div>
{% endblock %}
